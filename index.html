<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>COVID-19</title>
	<link rel="stylesheet" type="text/css" href="css/base.css">
	<link rel="icon" type="image/png" href="img/icons/ic_192.png">
	<meta name="description" content="Get informed of the latest information on COVID19 pandemic. Such as overview on cases, how to prevent the spread, how to protect loved ones from the deadly virus, what to do when you suspect others or yourself having the virus and so on">
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=2">
	<!-- set PWA -->
	<link rel="manifest" href="manifest.json">
	<meta name="theme-color" content="#38003c">
	<!-- iOS support -->
	<link rel="apple-touch-icon" href="img/icons/ic_192.png">
	<meta name="apple-mobile-app-status-bar" content="#38003c">
	<!-- end PWA -->
</head>
<body>
	<!-- top header -->
	<header class="theme_bg flex_space_around sticky_top">
		<div class="logo">
			<img src="img/icons/ic_192.png" class="full_dims">
		</div>
	</header>

	<!-- options -->
	<select id="modal" class="full_w" onchange="renderStats(this.value)">
		<!-- options will be loaded from the srver -->
		<!-- <option value="tz" selected>Tanzania</option> -->
	</select>

	<!-- main -->
	<main>
		<section class="flex_space_around">
			<!-- maambukizi -->
			<div class="full_w flex_space_around">
				<span id="maambukizi" class="case_number">...</span>
				<span class="case_title text_uppercase">Maambukizi</span>
			</div>
			<div class="full_w flex_space_around">
				<span id="maambukizi_mapya" class="case_number">...</span>
				<span class="case_title text_uppercase">Maambukizi  Mapya</span>
			</div>

			<!-- waliopona -->
			<div class="full_w flex_space_around">
				<span id="waliopona" class="case_number">...</span>
				<span class="case_title text_uppercase">Waliopona</span>
			</div>
			<div class="full_w flex_space_around">
				<span id="waliopona_wapya" class="case_number">...</span>
				<span class="case_title text_uppercase">Waliopona  Wapya</span>
			</div>

			<!-- vifo -->
			<div class="full_w flex_space_around">
				<span id="vifo" class="case_number">...</span>
				<span class="case_title text_uppercase">Vifo</span>
			</div>
			<div class="full_w flex_space_around">
				<span id="vifo_vipya" class="case_number">...</span>
				<span class="case_title text_uppercase">Vifo  Vipya</span>
			</div>

			<!-- sasishwa -->
			<div class="full_w flex_space_around">
				<span id="sasishwa" class="case_number">...</span>
				<span class="case_title text_uppercase">Sasishwa<!-- Last Updated --></span>
			</div>
		</section>
	</main>
<!-- scripts -->
<script src="js/base.js"></script>
<script src="js/AsyncRequest.js"></script>
<script>
	window.onload = e => {
		/* execute everything in this block */
		// registering a service worker
		if (navigator.serviceWorker) {
			navigator.serviceWorker.register('sw.js').catch(error => {
				consoleWarn(`error registering a service worker`, error);
			});
		}

		renderCountries();
		renderStats(`TZ`);
	};

	// renderCountries()
	function renderCountries () {
		const req = new AsyncRequest({
			url: `countries.json`,
			method: `get`
		});

		req.execute().then(res => {
			// consoleLog(res);
			if (res.statusOk) {
				// consoleLog(res);
				const responseBody = JSON.parse(res.body);
				// consoleLog(responseBody);

				let optionTemplate = ``;
				responseBody.countries.forEach(country => {
					optionTemplate += `
					<option value="${country.iso2}">${country.name}</option>
					`;
				});
				getNode(`select`).innerHTML = optionTemplate;
				getNode(`select`).value = `TZ`;
			} else {
				consoleWarn(`request status not ok`);
			}
		}).catch(err => {
			consoleWarn(`request error`);
		});
	}

	// renderStats()
	function renderStats (location) {
		// display a loading sign
		setText(`.case_number`, `...`);

		const req = new AsyncRequest({
			url: `https://api.smartable.ai/coronavirus/stats/${location}`,
			method: `get`,
			headers: {
				'Cache-Control': `no-cache`,
				'Subscription-Key': `API_KEY`
			}
		});

		req.execute().then(res => {
			// consoleLog(res);
			if (res.statusOk) {
				// consoleLog(res);
				const responseBody = JSON.parse(res.body);
				// consoleLog(responseBody);

				// maambukizi
				getNode(`#maambukizi`).textContent = `${responseBody.stats.totalConfirmedCases}`;
				getNode(`#maambukizi_mapya`).textContent = `${responseBody.stats.newlyConfirmedCases}`;
				// waliopona
				getNode(`#waliopona`).textContent = `${responseBody.stats.totalRecoveredCases}`;
				getNode(`#waliopona_wapya`).textContent = `${responseBody.stats.newlyRecoveredCases}`;
				// vifo
				getNode(`#vifo`).textContent = `${responseBody.stats.totalDeaths}`;
				getNode(`#vifo_vipya`).textContent = `${responseBody.stats.newDeaths}`;
				// sasishwa
				const sasishwaMuda = new Date(responseBody.updatedDateTime);
				getNode(`#sasishwa`).textContent = `${sasishwaMuda.getFullYear()}-${preppendZero(sasishwaMuda.getMonth()+1)}-${preppendZero(sasishwaMuda.getDate())}, ${preppendZero(sasishwaMuda.getHours())}:${preppendZero(sasishwaMuda.getMinutes())}:${preppendZero(sasishwaMuda.getSeconds())}`;
			} else {
				consoleWarn(`request status not ok`);
				setText(`.case_number`, `-`);
			}
		}).catch(err => {
			consoleWarn(`${err.message}`);
			setText(`.case_number`, `-`);
		});
	}

	// stting lents' textContent
	function setText (classNode, displayText) {
		getNodes(`${classNode}`).forEach(node => {
			node.textContent = `${displayText}`;
		});
	}
</script>
</body>
</html>
